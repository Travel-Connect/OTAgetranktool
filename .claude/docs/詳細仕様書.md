詳細仕様書 v1.1（確定版ドラフト）
1. 全体アーキテクチャ

Next.js：管理画面UI + API（ジョブ作成/実行/閲覧/Excel）

Supabase：

Auth（admin/viewer）

Postgres（マスタ・ジョブ・結果）

Storage（失敗時スクショ/HTML、Excelファイル）

Playwright：巡回ワーカー（最大並列5、UAローテ、速度制限）

定期実行：

外部タスクスケジューラ（要件の主語）→ /api/cron/daily を叩く

（代替）Vercel Cronでも同エンドポイントを叩ける設計

2. データモデル（Supabase/Postgres）
2.1 マスタ系
projects

id

name（例：那覇）

timezone（固定：Asia/Tokyo）

active

created_at

hotels

id

display_name（ホテルA/B/C）

memo

project_hotels

project_id

hotel_id

sort_order

hotel_ota_mappings（必須）

id

hotel_id

ota（enum）

ota_property_url（必須）

ota_property_id（取れる場合は保存）

enabled

unique(ota, ota_property_url) 推奨

v1.1は 施設URL/ID一致のみで同定（名前マッチはしない）

2.2 OTA検索プロファイル（URL最小要件＋差し替え）
ota_search_profiles

id

project_id

ota

base_url（ユーザーが貼り付ける “そのエリアの検索結果URL”）

variable_mapping_json

例：checkin→(f_nen1,f_tuki1,f_hi1) のような差し替え定義

allowlist_params_json（保持するクエリキー）

denylist_params_json（捨てるクエリキー）

enabled

ここが「URL最小要件を調査して効率巡回」の中核。
特にAgoda/Tripは揮発・計測パラメータが混じりやすいので、allowlist運用が前提。

各OTAパラメータ解析

2.3 プリセット（毎日実行のデフォルト条件セット）
project_default_presets（新設）

id

project_id

name（例：毎日_2ヶ月後平日_1-4名）

otas_json（対象OTA配列）

adults_per_room_json（例：[1,2,3,4]）

rooms_int（例：1）

nights_int（例：1）

date_mode（list / rule）

date_list_json（listの場合）

rule_json（ruleの場合）

base: run_date

offset_months: 2

weekdays: [Mon..Fri]

exclude_jp_holidays: true

generate_count: N（例：20）

enabled

2.4 ジョブ・タスク・結果
jobs

id

project_id

run_date（集計日）

preset_id（どのプリセットから作ったか）

status（queued/running/success/partial/failed）

started_at/finished_at

job_tasks

id

job_id

ota

checkin_date

nights

rooms

adults_per_room

attempt_count

status

last_error_code/last_error_message

started_at/finished_at

task_results

task_id（PK想定でも可）

total_count_int（総件数：取れなければnull）

total_count_raw_text（「◯件」原文）

ranks_json（{hotel_id: rank|null(圏外)}）

scanned_natural_count（何位までスキャンしたか：最大100）

debug_items_sample_json（先頭数件の抜粋：デバッグ用）

task_artifacts

task_id

screenshot_path（Storage）

html_path（Storage）

created_at

3. 日付生成ロジック（平日＝祝日除外）
3.1 ルール生成（rule_json）

入力：

基準日：run_date（集計日）

offset_months：N（例：2）

weekdays：Mon..Fri

exclude_jp_holidays：true

generate_count：K

処理：

target_start = run_date + offset_months

target_start 以降で weekday条件を満たす日を昇順列挙

日本の祝日に該当する日は除外

K件集まったら確定

実装方針：

祝日判定はライブラリ利用 or 自前祝日テーブル（年次更新）

v1.1は「振替休日・国民の休日」も祝日に含めて除外

4. ワーカー仕様（Playwright）
4.1 並列・速度制限（ブロック対策含む）

グローバル同時実行：5

追加の“礼儀”制御（v1.1で導入）：

ドメイン別最小間隔（例：1.5〜3.0秒＋ランダムジッター）

同一OTAの同時実行上限（例：最大2、デフォルト1推奨）

User-Agentローテーション：

デスクトップChrome/Edge/Safari相当のUAを複数用意し、タスクごとに切替

locale/Accept-Language、timezone、viewportも合わせて揺らしすぎない範囲で切替

注意：CAPTCHAを「解く」等の突破は実装しない。
CAPTCHA検出時は速度制限強化＋UA切替で再試行 → それでも出るなら失敗として証跡保存。

4.2 リトライ仕様（末尾回し）

取得失敗：

attempt_count += 1

status=queued に戻し、同ジョブ内のタスク末尾へ

最大3回失敗で status=failed（ジョブは完走）

4.3 自然順位（広告除外）の算出

一覧を上から走査し、各アイテムの isAd を判定

isAd=false のアイテムのみ自然順位カウントを進める

自然順位100に到達したら探索停止（圏外確定）

施設同定：

itemの施設URL（正規化）または施設IDが hotel_ota_mappings と一致したらヒット

4.4 “総件数（◯件）”の取得

原則、検索結果1ページ目のヘッダ/フィルタ付近から抽出

抽出できない場合は total_count_int = null、raw_textに取れた文字列だけ残す

5. OTA別仕様（URL生成・抽出項目・広告判定の方針）

ここは “実装に落とすためのI/Fと方針” を確定させています。
URLキーや最小要件は解析メモ準拠。

各OTAパラメータ解析

5.1 楽天トラベル（/ds/vacant/searchVacant）
URL差し替え（主要）

エリア：f_chu, f_shou（base_url固定）

各OTAパラメータ解析

チェックイン：f_nen1, f_tuki1, f_hi1

チェックアウト：f_nen2, f_tuki2, f_hi2（= checkin + nights）

各OTAパラメータ解析

室数：f_heya_su

大人人数（1室あたり）：f_otona_su

各OTAパラメータ解析

子供：f_s1,f_s2,f_y1..f_y4 を全て0固定

各OTAパラメータ解析

ページ：f_page（ページングで増加）

ソート：base_urlのまま固定（おすすめ順相当）
※f_sort等は「変更しない」が要件

抽出

一覧アイテム：施設URL/施設ID/施設名（デバッグ用）

広告判定：PR/広告表示、スポンサー枠のDOM（サイト改修に備え複数条件）

総件数：ヘッダの「◯件」

5.2 じゃらん（/{kenCd}/LRG_{lrgCd}/…）
URL差し替え（主要）

エリア：kenCd/lrgCd（パス＋クエリ両方の整合を保つ）

各OTAパラメータ解析

チェックイン：stayYear/stayMonth/stayDay

泊数：stayCount

室数：roomCount

大人人数：adultNum

内部互換：roomCrack = adultNum * 100000 を生成して上書き推奨

各OTAパラメータ解析

内部系：rootCd/distCd/reShFlg/mvTabFlg/listId/screenId は base_urlから維持

各OTAパラメータ解析

ソート：base_urlのまま

抽出

一覧アイテム：施設URL/施設ID（取れれば）/施設名

広告判定：PR枠のDOM/ラベル

総件数：一覧上部の件数表示

5.3 一休（/{area_slug}/{area_id}/）
URL差し替え（主要）

チェックイン：cid=YYYYMMDD

チェックアウト：cod=YYYYMMDD

大人：ppc

室数：rc

泊数：lc（cid/codから導出できるため、矛盾時はcid/cod優先）

各OTAパラメータ解析

ソート系：discsort 等は base_url維持（おすすめ順固定）

各OTAパラメータ解析

抽出

一覧アイテム：施設URL/施設ID（あれば）

広告判定：PR/スポンサー表記

総件数：件数UI

5.4 Expedia（/Hotel-Search）
URL差し替え（主要）

目的地：regionId（base_url固定。destination文字列は保持するが必須ではない）

各OTAパラメータ解析

日付：startDate/endDate（+互換で d1/d2 も同値で出す方針）

各OTAパラメータ解析

大人：adults（合計扱い）

室数：rooms

ソート：sort は base_url維持（RECOMMENDED相当）

各OTAパラメータ解析

抽出

一覧アイテム：ホテル詳細URL（正規化して一致判定）

広告判定：Sponsored等のラベル

総件数：件数表示（無い場合null）

5.5 Booking.com（/searchresults.ja.html）
URL差し替え（主要）

目的地：dest_id/dest_type（base_url固定）、表示用に ss も維持可

各OTAパラメータ解析

日付：checkin/checkout

大人：group_adults（合計）

室数：no_rooms

子供：group_children=0

追跡系：aid/label/src 等は原則drop（base_urlに残っていても正規化で除去可能）

各OTAパラメータ解析

抽出

一覧アイテム：施設URL/施設ID（あれば）

広告判定：Sponsored表示、広告スロット

総件数：件数UI

5.6 Agoda（/ja-jp/search）
URL差し替え（主要）

目的地：region + textToSearch（base_url固定）

各OTAパラメータ解析

日付：checkIn/checkOut（+ los は導出して矛盾時上書き）

各OTAパラメータ解析

室数：rooms

大人：adults（合計扱い想定）

子供：children=0

通貨：currencyCode=JPY を維持

揮発/個体識別：ckuid/userId/correlationId/analyticsSessionId/machineName/ds 等はdrop（完全再生モードはv1.1では使わない）

各OTAパラメータ解析

抽出

一覧アイテム：施設URL/施設ID

広告判定：スポンサー/広告のラベル

総件数：件数UI（無ければnull）

5.7 Trip.com（/hotels/list）
URL差し替え（主要）

日付：checkIn/checkOut

室数：crn

大人：adult

子供：children=0

通貨：barCurr=JPY

目的地：searchType/searchWord/searchValue は ブラックボックスとしてbase_url固定（生成しない）

各OTAパラメータ解析

計測：ctm_ref 等はdrop可能

各OTAパラメータ解析

抽出

一覧アイテム：施設URL/施設ID

広告判定：広告ラベル

総件数：件数UI

6. Excel出力仕様（v1.1確定）

1ファイル = 1ジョブ（集計日×プロジェクト）

シート = OTAごと（7シート）

各シート：

ヘッダ：集計日/エリア/泊数/室数/広告除外/圏外閾値100

セクション：人数（1室あたり1名/2名/3名/4名…）

テーブル：行=ホテル、列=チェックイン日、値=自然順位（圏外は「-」）

総件数：日付列に対応する「総件数」行（nullの場合は空欄）

7. ログ・監視・証跡（運用必須）

taskごとに保存：

実行URL（正規化後）

失敗理由（timeout / navigation / blocked / parse_error）

attempt_count

失敗時は必ず artifacts 保存：

screenshot（fullPage推奨）

html（取得できた場合）

画面「実行履歴」で

失敗タスク一覧

スクショ/HTMLへのリンク

直近の失敗傾向（OTA別）を確認可能にする

8. 3カ月保持の削除仕様（v1.1確定）

毎日 cleanup を実行し、以下を削除：

run_date < (今日 - 3カ月) の jobs

ぶら下がる job_tasks / task_results / task_artifacts

Storage上の screenshot/html/excel

削除は「DB削除 → Storage削除」の順で行い、途中失敗しても再実行で収束する作りにする。