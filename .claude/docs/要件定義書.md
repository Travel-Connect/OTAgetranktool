要件定義書 v1.1（確定版ドラフト）
0. 決定事項サマリ（Q1〜Q13反映）

取得する件数指標：検索結果の総件数（◯件）（表示件数ではない）

順位定義：広告/PR/スポンサー枠は除外して自然順位を算出

圏外：自然順位101位以降は「圏外」（＝自然順位上位100件まで探索）

対象ホテルの同定：OTA施設ID/施設URLで登録（必須）

日付指定：任意日付リスト＋ルール生成（両方）

泊数・室数：ユーザーが選択可能

定期実行：毎日実行（タスクスケジューラ）

保存期間：直近3カ月のみ保持

平日定義：月〜金、ただし日本の祝日は除外

ソート：各OTAデフォルト（おすすめ順）

子供：0固定（UIにも出さない）

ブロック対策：別UA等＋速度制限（両方）で回避を試みる（ただしCAPTCHA自体の自動突破はしない）

1. 目的

指定したホテル（複数）について、対象OTA（楽天/じゃらん/一休/Expedia/Booking.com/Agoda/Trip.com）に対し、指定条件で検索結果一覧を取得して

対象ホテルの 自然順位（広告除外）

検索結果の 総件数（◯件）

を自動収集し、画面表示・Excel出力・履歴保存（3カ月）できるツールを提供する。

2. 対象OTA

楽天トラベル

じゃらん

一休

Expedia

Booking.com

Agoda

Trip.com

3. 入力（検索条件）

ユーザーが任意に指定できるパラメータ：

エリア（プロジェクト/OTA検索プロファイルで定義）

チェックイン日（任意リスト or ルール生成）

泊数（nights）

室数（rooms）

大人人数（adults）

対象OTA（複数選択）

v1.1固定：

子供人数：0（UI無し）

並び順：OTAデフォルト（おすすめ順）固定

人数の扱い（v1.1定義）
UIは「大人人数（1室あたり）」×「室数」とする（全室同一人数とみなす）。
OTAが「合計人数」しか受けない場合は total_adults = adults_per_room * rooms に変換してURLへ反映する。

4. 出力

画面：OTA×人数×日付のマトリクス（ホテル行×宿泊日列）

Excel：同等構造（OTA別シート＋人数セクション＋総件数行）

保存：ジョブ（集計日）単位で保存し、3カ月経過分は削除

5. 取得仕様（巡回・安定運用）

タスク単位：OTA × checkin_date × adults_per_room × rooms × nights

最大並列：5

巡回順：チェックイン日昇順

リトライ：失敗タスクは末尾に回して最大3回

圏外：自然順位上位100件まで探索し、見つからなければ圏外

取得の揺れ抑制：

URL最小要件（allowlist/denylist）で正規化して巡回

各OTAパラメータ解析

速度制限（ドメイン別の最小間隔＋ジッター）

User-Agentローテーション（複数UAの持ち回り）

それでもCAPTCHA等が出た場合は「失敗扱い＋証跡保存」

6. 定期実行（毎日）

毎日、全プロジェクトについて「デフォルト条件セット（プリセット）」でジョブを自動作成・実行する。

7. 平日定義（ルール生成）

平日：月〜金

ただし 日本の祝日を除外（祝日一覧に基づく）

祝日扱い：振替休日・国民の休日も含めて除外（v1.1の実装方針）

8. 保存期間

直近3カ月のみ保存

3カ月を超えたジョブ/結果/ログ/スクリーンショット/HTMLは削除（自動）

9. 受入基準（Acceptance Criteria）

任意条件で実行したとき、各OTAごとに

「総件数」が取得できる場合はDBに保存され、画面/Excelに出る

広告枠除外後の自然順位が1〜100で取得できる（対象ホテルが100位以内のとき）

100位以内に無ければ「圏外」として保存される

ネットワークエラー等があっても、日付昇順巡回＋末尾回しリトライ（最大3回）でジョブは完走する

毎日実行で全プロジェクトが自動処理される

3カ月超のデータが自動削除される